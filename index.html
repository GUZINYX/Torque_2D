<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Torque 2D - Speed Edition</title>
    <style>
        :root {
            --neon-orange: #ff8c00;
            --neon-green: #00ff00;
            --neon-blue: #00eaff;
            --bg-brick: #0a0a0a;
            --bg-panel: rgba(20, 20, 20, 0.95);
        }

        body { 
            background-color: var(--bg-brick);
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(0,234,255,0.1) 0%, transparent 60%),
                repeating-linear-gradient(to right, #111 0px, #111 2px, transparent 2px, transparent 40px),
                repeating-linear-gradient(to bottom, #0f0f0f 0px, #0f0f0f 2px, transparent 2px, transparent 20px);
            color: #eee; 
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            margin: 0; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* --- SHOP OVERLAY --- */
        #shop-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .shop-container {
            background: var(--bg-panel);
            border: 2px solid var(--neon-blue);
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            box-shadow: 0 0 20px var(--neon-blue);
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .shop-item button {
            background: transparent;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }
        .shop-item button:disabled { color: #555; border-color: #555; cursor: not-allowed; }

        /* --- HUD --- */
        #ui-top {
            width: 98%;
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px 0;
            position: absolute;
            top: 0;
            pointer-events: none;
        }

        .hud-panel {
            background: var(--bg-panel);
            border: 2px solid var(--neon-orange);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.2) inset, 0 0 5px var(--neon-orange);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 180px;
            text-align: center;
            white-space: nowrap;
        }

        .hud-label { color: var(--neon-orange); font-weight: bold; margin-right: 5px; }
        #engine-status.online { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        #engine-status.offline { color: #ff4444; text-shadow: 0 0 10px #ff0000; }

        /* --- CANVAS --- */
        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            position: relative;
            margin-bottom: 80px;
        }

        canvas { 
            border-bottom: 4px solid #333;
            background: linear-gradient(to bottom, transparent 60%, rgba(40,40,40,1) 60%, rgba(20,20,20,1) 100%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            cursor: crosshair;
        }
        
        .overhead-light {
            position: absolute;
            top: 100px;
            width: 400px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 50px 10px var(--neon-blue), 0 0 100px 20px white;
            z-index: 1;
        }

        /* --- CONTROLS --- */
        #controls { 
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            border-top: 3px solid #333;
            padding: 15px; 
            display: flex; 
            justify-content: center;
            gap: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.7);
        }

        .control-btn { 
            padding: 12px 20px; 
            cursor: pointer; 
            font-weight: bold;
            background: transparent;
            color: var(--neon-orange);
            border: 2px solid var(--neon-orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
        }
        .active-tool { background: var(--neon-orange); color: #000; }
        .btn-action { border-color: var(--neon-green); color: var(--neon-green); }
        .btn-shop { border-color: var(--neon-blue); color: var(--neon-blue); }
        .btn-sell { border-color: #ff4444; color: #ff4444; }
    </style>
</head>
<body>

    <div class="overhead-light"></div>

    <div id="ui-top">
        <div class="hud-panel" style="border-color: var(--neon-blue);"><span class="hud-label" style="color: var(--neon-blue);">CARTEIRA:</span> $<span id="credits-label">1400</span></div>
        <div class="hud-panel"><span class="hud-label">MOTOR:</span> <span id="engine-status" class="offline">OFFLINE</span></div>
        <div class="hud-panel"><span class="hud-label">√ìLEO:</span> <span id="oil-counter">0 / 100%</span></div>
        <div class="hud-panel"><span class="hud-label">VELOCIDADE:</span> <span id="kmh-label">0</span> KM/H</div>
    </div>

    <div id="shop-overlay">
        <div class="shop-container">
            <h2 style="color: var(--neon-blue); margin-top: 0;">AUTO PE√áAS TORQUE</h2>
            <div id="shop-list"></div>
            <button class="control-btn btn-shop" style="width: 100%; margin-top: 20px; justify-content: center;" onclick="toggleShop()">SAIR DA LOJA</button>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="c" width="1024" height="600"></canvas>
    </div>

    <div id="controls">
        <button class="control-btn btn-shop" onclick="toggleShop()"><span>üõí</span> Loja</button>
        <button id="btn-hand" class="control-btn active-tool" onclick="setTool('hand')"><span>üñêÔ∏è</span> Arrastar</button>
        <button id="btn-wrench" class="control-btn" onclick="setTool('wrench')"><span>üîß</span> Chave</button>
        <button id="btn-oil" class="control-btn" onclick="setTool('oil')"><span>üõ¢Ô∏è</span> √ìleo</button>
        <button id="btn-ign" class="control-btn btn-action" onclick="attemptIgnition()" disabled><span>üîë</span> Igni√ß√£o</button>
        <button id="btn-sell" class="control-btn btn-sell" onclick="sellEngine()" disabled><span>üí∞</span> Vender</button>
    </div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSynthSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode); gainNode.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    switch (type) {
        case 'grab': osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.06); break;
        case 'install': osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.15, now); osc.start(now); osc.stop(now + 0.2); break;
        case 'wrench': 
            osc.type = 'square'; osc.frequency.setValueAtTime(1200, now); gainNode.gain.setValueAtTime(0.05, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.05); osc.start(now); osc.stop(now + 0.05); break;
        case 'oil': osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.2); break;
        case 'ignition': osc.type = 'sawtooth'; osc.frequency.setValueAtTime(60, now); osc.frequency.linearRampToValueAtTime(300, now + 1.5); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 1.5); break;
        case 'money': osc.type = 'sine'; osc.frequency.setValueAtTime(900, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.1); break;
    }
}

const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
const GRAVITY = 0.5, FRICTION = 0.92, FLOOR_LEVEL = 580, MOUSE_PULL_STRENGTH = 0.15;
const standPos = { x: 450, y: 250 };
let tool = 'hand', engineReady = false, oilLevel = 0, credits = 1400, parts = [], draggedPart = null, mouseTargetPos = {x:0, y:0};

const shopCatalog = [
    { id: 'block', name: 'BLOCO', price: 500, w: 140, h: 110, color: '#9da5b4', stroke:'#2b2b2b', tx: standPos.x - 70, ty: standPos.y - 50, req: null, maxBolts: 4, speedPlus: 0 },
    { id: 'crank', name: 'VIRAQUIM', price: 300, w: 120, h: 30, color: '#3a4a63', stroke:'#1a1a2e', tx: standPos.x - 60, ty: standPos.y + 40, req: 'block', maxBolts: 2, speedPlus: 0 },
    { id: 'head', name: 'CABE√áOTE', price: 400, w: 150, h: 50, color: '#c92a2a', stroke:'#7c1a1a', tx: standPos.x - 75, ty: standPos.y - 100, req: 'block', maxBolts: 4, speedPlus: 0 },
    { id: 'pan', name: 'C√ÅRTER', price: 200, w: 130, h: 40, color: '#1a1a1a', stroke:'#000', tx: standPos.x - 65, ty: standPos.y + 80, req: 'crank', maxBolts: 4, speedPlus: 0 },
    { id: 'turbo', name: 'KIT TURBO', price: 1200, w: 70, h: 70, color: '#00eaff', stroke:'#005a8d', tx: standPos.x + 80, ty: standPos.y - 60, req: 'head', maxBolts: 3, speedPlus: 30 },
    { id: 'inter', name: 'INTERCOOLER', price: 800, w: 120, h: 45, color: '#5555ff', stroke:'#111155', tx: standPos.x - 60, ty: standPos.y - 160, req: 'turbo', maxBolts: 2, speedPlus: 20 }
];

function toggleShop() {
    const s = document.getElementById('shop-overlay');
    s.style.display = (s.style.display === 'flex') ? 'none' : 'flex';
    if(s.style.display === 'flex') renderShop();
}

function renderShop() {
    const list = document.getElementById('shop-list');
    list.innerHTML = '';
    shopCatalog.forEach(item => {
        const jaTem = parts.find(p => p.id === item.id);
        list.innerHTML += `<div class="shop-item"><span style="color:white">${item.name} - $${item.price}</span>
            <button onclick="buyPart('${item.id}')" ${jaTem || credits < item.price ? 'disabled' : ''}>${jaTem ? 'OK' : 'COMPRAR'}</button></div>`;
    });
}

function buyPart(id) {
    const item = shopCatalog.find(i => i.id === id);
    if (credits >= item.price) {
        credits -= item.price; document.getElementById('credits-label').innerText = credits;
        parts.push({ ...item, x: 50 + Math.random()*200, y: -50, vx: 0, vy: 0, bolts: 0, installed: false });
        playSynthSound('install'); renderShop();
    }
}

function sellEngine() {
    let value = parts.reduce((acc, p) => acc + p.price, 0);
    credits += Math.floor(value * 1.5); 
    document.getElementById('credits-label').innerText = credits;
    
    parts = []; 
    engineReady = false; 
    oilLevel = 0;
    
    document.getElementById('engine-status').innerText = "OFFLINE";
    document.getElementById('engine-status').className = "offline";
    document.getElementById('oil-counter').innerText = "0 / 100%";
    document.getElementById('kmh-label').innerText = "0";
    
    playSynthSound('money'); 
    checkEngineStatus();
}

function loop() {
    updatePhysics();
    draw();
    requestAnimationFrame(loop);
}

function updatePhysics() {
    parts.forEach(p => {
        if (p.installed) return;
        if (p === draggedPart) {
            p.vx += (mouseTargetPos.x - (p.x + p.w / 2)) * MOUSE_PULL_STRENGTH;
            p.vy += (mouseTargetPos.y - (p.y + p.h / 2)) * MOUSE_PULL_STRENGTH;
            p.vx *= 0.8; p.vy *= 0.8;
        } else {
            p.vy += GRAVITY; p.vx *= FRICTION; p.vy *= FRICTION;
            if (p.y + p.h > FLOOR_LEVEL) { p.y = FLOOR_LEVEL - p.h; p.vy = -p.vy * 0.3; p.vx *= 0.8; }
        }
        p.x += p.vx; p.y += p.vy;
    });
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const next = parts.find(p => !p.installed && (!p.req || parts.find(r => r.id === p.req && r.installed)));
    if (next) {
        const isNear = Math.hypot(next.x - next.tx, next.y - next.ty) < 60;
        ctx.save();
        ctx.strokeStyle = isNear ? '#00ff00' : '#ff0000';
        ctx.lineWidth = 3; ctx.setLineDash([5, 5]);
        ctx.strokeRect(next.tx, next.ty, next.w, next.h);
        ctx.restore();
    }

    ctx.strokeStyle = 'rgba(0, 234, 255, 0.6)'; ctx.lineWidth = 3; ctx.strokeRect(standPos.x - 90, standPos.y + 130, 180, 20);

    parts.forEach(p => {
        ctx.save();
        const grad = ctx.createLinearGradient(p.x, p.y, p.x, p.y + p.h);
        grad.addColorStop(0, p.color); grad.addColorStop(1, p.stroke);
        ctx.fillStyle = grad;
        ctx.strokeStyle = p.installed ? (p.bolts === p.maxBolts ? '#00ff00' : '#ff8c00') : p.stroke;
        ctx.lineWidth = 2; ctx.fillRect(p.x, p.y, p.w, p.h); ctx.strokeRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = 'white'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(p.name, p.x + p.w / 2, p.y - 10);
        if(p.installed) {
            for(let i=1; i<=p.maxBolts; i++) {
                ctx.beginPath(); ctx.arc(p.x + (p.w/(p.maxBolts+1)*i), p.y + p.h - 10, 5, 0, Math.PI*2);
                ctx.fillStyle = i <= p.bolts ? '#00ff00' : '#444'; ctx.fill();
            }
        }
        ctx.restore();
    });

    if(engineReady) {
        // Velocidade base de 60 KM/h + b√¥nus das pe√ßas
        let bonusSpeed = 0;
        parts.forEach(p => {
            if(p.installed) bonusSpeed += p.speedPlus;
        });
        let maxKmh = 60 + bonusSpeed;
        // Oscila√ß√£o natural do motor ligado
        let jitter = (Math.random() * 2) - 1;
        let finalKmh = maxKmh + jitter;
        document.getElementById('kmh-label').innerText = Math.floor(finalKmh);
    } else {
        document.getElementById('kmh-label').innerText = "0";
    }
}

canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    if (tool === 'hand') {
        draggedPart = [...parts].reverse().find(p => !p.installed && mx > p.x && mx < p.x + p.w && my > p.y && my < p.y + p.h);
        if(draggedPart) playSynthSound('grab');
    } else if (tool === 'wrench') {
        parts.forEach(p => {
            if(p.installed && p.bolts < p.maxBolts && mx > p.x && mx < p.x+p.w && my > p.y && my < p.y+p.h) {
                p.bolts++; playSynthSound('wrench'); checkEngineStatus();
            }
        });
    } else if (tool === 'oil') {
        oilLevel = Math.min(oilLevel + 5, 100); playSynthSound('oil');
        document.getElementById('oil-counter').innerText = oilLevel + " / 100%";
        checkEngineStatus();
    }
});

canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    mouseTargetPos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
});

canvas.addEventListener('mouseup', () => {
    if (draggedPart) {
        const dist = Math.hypot(draggedPart.x - draggedPart.tx, draggedPart.y - draggedPart.ty);
        const dep = !draggedPart.req || parts.find(p => p.id === draggedPart.req && p.installed);
        if (dist < 50 && dep) {
            draggedPart.x = draggedPart.tx; draggedPart.y = draggedPart.ty;
            draggedPart.installed = true; playSynthSound('install');
        }
        draggedPart = null; checkEngineStatus();
    }
});

function setTool(t) {
    tool = t;
    document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active-tool'));
    if(document.getElementById('btn-' + t)) document.getElementById('btn-' + t).classList.add('active-tool');
}

function checkEngineStatus() {
    const coreIds = ['block', 'crank', 'head', 'pan'];
    const coresDone = coreIds.every(id => {
        const p = parts.find(part => part.id === id);
        return p && p.installed && p.bolts === p.maxBolts;
    });
    const extrasDone = parts.filter(p => !coreIds.includes(p.id)).every(p => p.installed && p.bolts === p.maxBolts);
    const readyToIgnite = (coresDone && extrasDone && oilLevel === 100);
    
    document.getElementById('btn-ign').disabled = !readyToIgnite || engineReady;
    document.getElementById('btn-sell').disabled = !engineReady;
}

function attemptIgnition() {
    playSynthSound('ignition');
    setTimeout(() => {
        engineReady = true;
        document.getElementById('engine-status').innerText = "ONLINE";
        document.getElementById('engine-status').className = "online";
        checkEngineStatus();
    }, 1500);
}

loop();
</script>
</body>
</html>